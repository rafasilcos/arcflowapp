const axios = require('axios')

// Configura√ß√£o
const BASE_URL = 'http://localhost:3001/api'
let authToken = ''

// Fun√ß√£o para fazer login e obter token
async function login() {
  try {
    console.log('üîê Fazendo login...')
    
    const response = await axios.post(`${BASE_URL}/auth/login`, {
      email: 'admin@arcflow.com',
      password: '123456'
    })
    
    if (response.data.tokens) {
      authToken = response.data.tokens.accessToken
      console.log('‚úÖ Login realizado com sucesso')
      console.log('üë§ Usu√°rio:', response.data.user.nome)
      console.log('üè¢ Escrit√≥rio:', response.data.escritorio.nome)
      console.log('üìã Plano:', response.data.escritorio.planId)
      return true
    }
    
    return false
  } catch (error) {
    console.error('‚ùå Erro no login:', error.response?.data || error.message)
    return false
  }
}

// Fun√ß√£o para fazer requisi√ß√µes autenticadas
async function makeRequest(method, endpoint, data = null) {
  try {
    const config = {
      method,
      url: `${BASE_URL}${endpoint}`,
      headers: {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      }
    }
    
    if (data) {
      config.data = data
    }
    
    const response = await axios(config)
    return { success: true, data: response.data }
  } catch (error) {
    return { 
      success: false, 
      error: error.response?.data || error.message,
      status: error.response?.status
    }
  }
}

// Teste 1: Verificar configura√ß√µes enterprise
async function testeConfiguracoes() {
  console.log('\nüìä Testando configura√ß√µes enterprise...')
  
  const result = await makeRequest('GET', '/enterprise/config')
  
  if (result.success) {
    console.log('‚úÖ Configura√ß√µes obtidas com sucesso')
    console.log('üìã Plano:', result.data.data.plano)
    console.log('üìä Status:', result.data.data.status)
    console.log('üë• Usu√°rios:', result.data.data.estatisticas.usuarios)
    console.log('üìÅ Projetos:', result.data.data.estatisticas.projetos)
    console.log('üíæ Storage:', Math.round(result.data.data.estatisticas.storage / (1024*1024)), 'MB')
    
    if (result.data.data.configuracoes.recursos) {
      console.log('üîß Recursos dispon√≠veis:')
      console.log('  - API:', result.data.data.configuracoes.recursos.api ? '‚úÖ' : '‚ùå')
      console.log('  - Integra√ß√£o:', result.data.data.configuracoes.recursos.integracao ? '‚úÖ' : '‚ùå')
      console.log('  - Relat√≥rios Avan√ßados:', result.data.data.configuracoes.recursos.relatoriosAvancados ? '‚úÖ' : '‚ùå')
      console.log('  - Suporte Dedicado:', result.data.data.configuracoes.recursos.suporteDedicado ? '‚úÖ' : '‚ùå')
      console.log('  - Backup:', result.data.data.configuracoes.recursos.backup ? '‚úÖ' : '‚ùå')
    }
    
    return true
  } else {
    console.error('‚ùå Erro ao obter configura√ß√µes:', result.error)
    return false
  }
}

// Teste 2: Listar API Keys
async function testeApiKeys() {
  console.log('\nüîë Testando API Keys...')
  
  const result = await makeRequest('GET', '/enterprise/api-keys')
  
  if (result.success) {
    console.log('‚úÖ API Keys listadas com sucesso')
    console.log('üìä Total de keys:', result.data.data.length)
    
    if (result.data.data.length > 0) {
      result.data.data.forEach((key, index) => {
        console.log(`  ${index + 1}. ${key.nome} - ${key.chave} (${key.ativa ? 'Ativa' : 'Inativa'})`)
      })
    } else {
      console.log('üìù Nenhuma API key encontrada')
    }
    
    return true
  } else {
    console.error('‚ùå Erro ao listar API keys:', result.error)
    return false
  }
}

// Teste 3: Criar nova API Key
async function testeCriarApiKey() {
  console.log('\n‚ûï Testando cria√ß√£o de API Key...')
  
  const novaKey = {
    nome: 'API Key de Teste',
    permissoes: {
      leitura: true,
      escrita: false,
      admin: false,
      modulos: ['clientes', 'projetos']
    },
    expiresIn: 30 // 30 dias
  }
  
  const result = await makeRequest('POST', '/enterprise/api-keys', novaKey)
  
  if (result.success) {
    console.log('‚úÖ API Key criada com sucesso')
    console.log('üîë Nome:', result.data.data.nome)
    console.log('üîê Chave:', result.data.data.chave)
    console.log('‚ö†Ô∏è Aviso:', result.data.data.warning)
    
    // Salvar ID para teste de dele√ß√£o
    global.testApiKeyId = result.data.data.chave.split('_')[1] // Simular ID
    
    return true
  } else {
    console.error('‚ùå Erro ao criar API key:', result.error)
    return false
  }
}

// Teste 4: Relat√≥rio de uso
async function testeRelatorioUso() {
  console.log('\nüìà Testando relat√≥rio de uso...')
  
  const result = await makeRequest('GET', '/enterprise/reports/usage?periodo=30d')
  
  if (result.success) {
    console.log('‚úÖ Relat√≥rio de uso gerado com sucesso')
    console.log('üìÖ Per√≠odo:', result.data.data.periodo)
    
    const uso = result.data.data.uso
    console.log('üìä Uso atual:')
    console.log(`  üë• Usu√°rios: ${uso.usuarios.total}/${uso.usuarios.limite} (${uso.usuarios.percentual}%)`)
    console.log(`  üìÅ Projetos: ${uso.projetos.total}/${uso.projetos.limite} (${uso.projetos.percentual}%)`)
    console.log(`  üíæ Storage: ${Math.round(uso.storage.total/(1024*1024*1024))}GB/${Math.round(uso.storage.limite/(1024*1024*1024))}GB (${uso.storage.percentual}%)`)
    console.log(`  üîó API: ${uso.api.chamadas}/${uso.api.limite} (${uso.api.percentual}%)`)
    
    if (result.data.data.alertas.length > 0) {
      console.log('‚ö†Ô∏è Alertas:')
      result.data.data.alertas.forEach(alerta => {
        console.log(`  - ${alerta.mensagem}`)
      })
    } else {
      console.log('‚úÖ Nenhum alerta de limite')
    }
    
    return true
  } else {
    console.error('‚ùå Erro ao gerar relat√≥rio:', result.error)
    return false
  }
}

// Teste 5: Backup manual
async function testeBackupManual() {
  console.log('\nüíæ Testando backup manual...')
  
  const backup = {
    tipo: 'completo',
    descricao: 'Backup de teste via API Enterprise'
  }
  
  const result = await makeRequest('POST', '/enterprise/backup/manual', backup)
  
  if (result.success) {
    console.log('‚úÖ Backup iniciado com sucesso')
    console.log('üÜî ID:', result.data.data.id)
    console.log('üìã Tipo:', result.data.data.tipo)
    console.log('‚è±Ô∏è Status:', result.data.data.status)
    console.log('‚è∞ Estimativa:', result.data.data.estimativa)
    
    // Aguardar um pouco e verificar hist√≥rico
    console.log('‚è≥ Aguardando 6 segundos para verificar conclus√£o...')
    await new Promise(resolve => setTimeout(resolve, 6000))
    
    return await testeHistoricoBackup()
  } else {
    console.error('‚ùå Erro ao iniciar backup:', result.error)
    return false
  }
}

// Teste 6: Hist√≥rico de backup
async function testeHistoricoBackup() {
  console.log('\nüìö Testando hist√≥rico de backup...')
  
  const result = await makeRequest('GET', '/enterprise/backup/history?limit=5')
  
  if (result.success) {
    console.log('‚úÖ Hist√≥rico obtido com sucesso')
    console.log('üìä Total de backups:', result.data.data.length)
    
    if (result.data.data.length > 0) {
      console.log('üìã √öltimos backups:')
      result.data.data.forEach((backup, index) => {
        const status = backup.status === 'concluido' ? '‚úÖ' : backup.status === 'iniciando' ? '‚è≥' : '‚ùå'
        console.log(`  ${index + 1}. ${backup.tipo} - ${status} ${backup.status} (${backup.descricao})`)
        if (backup.tamanho_mb) {
          console.log(`     üíæ Tamanho: ${backup.tamanho_mb}MB`)
        }
      })
    }
    
    return true
  } else {
    console.error('‚ùå Erro ao obter hist√≥rico:', result.error)
    return false
  }
}

// Teste 7: White Label (apenas para ENTERPRISE)
async function testeWhiteLabel() {
  console.log('\nüé® Testando configura√ß√µes de White Label...')
  
  const whiteLabel = {
    logo: {
      principal: 'https://exemplo.com/logo.png',
      favicon: 'https://exemplo.com/favicon.ico'
    },
    cores: {
      primaria: '#FF6B35',
      secundaria: '#2E86AB',
      acento: '#A23B72'
    },
    dominio: {
      customizado: 'app.meuescritorio.com.br',
      ssl: true
    },
    marca: {
      nomeExibicao: 'Meu Escrit√≥rio Pro',
      slogan: 'Projetos que transformam',
      copyright: '¬© 2024 Meu Escrit√≥rio'
    }
  }
  
  const result = await makeRequest('PUT', '/enterprise/white-label', whiteLabel)
  
  if (result.success) {
    console.log('‚úÖ White Label configurado com sucesso')
    console.log('üé® Configura√ß√µes aplicadas:')
    console.log('  - Logo:', result.data.data.logo.principal)
    console.log('  - Cores:', Object.keys(result.data.data.cores).join(', '))
    console.log('  - Dom√≠nio:', result.data.data.dominio.customizado)
    console.log('  - Marca:', result.data.data.marca.nomeExibicao)
    
    return true
  } else {
    if (result.status === 403) {
      console.log('‚ö†Ô∏è White Label dispon√≠vel apenas para plano ENTERPRISE')
      return true // N√£o √© erro, √© esperado para outros planos
    }
    console.error('‚ùå Erro ao configurar White Label:', result.error)
    return false
  }
}

// Fun√ß√£o principal de teste
async function executarTestes() {
  console.log('üöÄ Iniciando testes do sistema Enterprise ArcFlow')
  console.log('=' * 50)
  
  // Login
  const loginSuccess = await login()
  if (!loginSuccess) {
    console.error('‚ùå Falha no login. Encerrando testes.')
    return
  }
  
  // Executar testes
  const testes = [
    { nome: 'Configura√ß√µes Enterprise', func: testeConfiguracoes },
    { nome: 'API Keys - Listar', func: testeApiKeys },
    { nome: 'API Keys - Criar', func: testeCriarApiKey },
    { nome: 'Relat√≥rio de Uso', func: testeRelatorioUso },
    { nome: 'Backup Manual', func: testeBackupManual },
    { nome: 'White Label', func: testeWhiteLabel }
  ]
  
  let sucessos = 0
  let falhas = 0
  
  for (const teste of testes) {
    try {
      const resultado = await teste.func()
      if (resultado) {
        sucessos++
      } else {
        falhas++
      }
    } catch (error) {
      console.error(`‚ùå Erro no teste ${teste.nome}:`, error.message)
      falhas++
    }
    
    // Pausa entre testes
    await new Promise(resolve => setTimeout(resolve, 1000))
  }
  
  // Resumo final
  console.log('\n' + '=' * 50)
  console.log('üìä RESUMO DOS TESTES ENTERPRISE')
  console.log('=' * 50)
  console.log(`‚úÖ Sucessos: ${sucessos}`)
  console.log(`‚ùå Falhas: ${falhas}`)
  console.log(`üìä Total: ${sucessos + falhas}`)
  console.log(`üéØ Taxa de sucesso: ${Math.round((sucessos / (sucessos + falhas)) * 100)}%`)
  
  if (falhas === 0) {
    console.log('\nüéâ TODOS OS TESTES PASSARAM! Sistema Enterprise funcionando perfeitamente!')
  } else {
    console.log('\n‚ö†Ô∏è Alguns testes falharam. Verifique os logs acima.')
  }
}

// Executar testes
if (require.main === module) {
  executarTestes().catch(console.error)
}

module.exports = { executarTestes } 