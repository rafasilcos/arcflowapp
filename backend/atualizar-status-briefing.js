/**
 * üîß ATUALIZAR CRONOGRAMA COM DETALHAMENTO T√âCNICO COMPLETO
 * Implementar os entreg√°veis detalhados conforme especifica√ß√£o t√©cnica
 */

const { Client } = require('pg');

async function atualizarCronogramaDetalhado() {
  const client = new Client({
    connectionString: "postgresql://postgres.lxatittpiiufvubyggzb:obm101264@aws-0-sa-east-1.pooler.supabase.com:6543/postgres"
  });

  try {
    await client.connect();
    
    console.log('üîß ATUALIZANDO CRONOGRAMA COM DETALHAMENTO T√âCNICO COMPLETO');
    console.log('='.repeat(60));
    
    const orcamentoId = 61;
    
    // Buscar cronograma atual
    const result = await client.query(`
      SELECT cronograma FROM orcamentos WHERE id = $1
    `, [orcamentoId]);
    
    const cronogramaAtual = result.rows[0].cronograma;
    
    // Cronograma atualizado com detalhamento t√©cnico completo
    const cronogramaAtualizado = {
      ...cronogramaAtual,
      fases: {
        // FASE 1: LEVANTAMENTO DE DADOS
        "LV_LEVANTAMENTO_DADOS": {
          "ordem": 1,
          "etapa": "A - CONCEP√á√ÉO",
          "nome": "LV - Levantamento de Dados",
          "prazo": 1,
          "valor": 1275,
          "percentual": 0.05,
          "disciplinas": ["ARQUITETURA"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Levantamento topogr√°fico georreferenciado com curvas de n√≠vel e pontos not√°veis",
            "Cadastro t√©cnico da edifica√ß√£o existente (quando houver), incluindo levantamento arquitet√¥nico, estrutural, instala√ß√µes e patologias",
            "Levantamento de dados clim√°ticos e orienta√ß√£o solar (heliodiagrama, rosa dos ventos, sombreamento)",
            "Levantamento geot√©cnico e sondagens do solo (SPT, an√°lise estratigr√°fica)",
            "Levantamento de infraestrutura local (acessos, redes p√∫blicas de √°gua, esgoto, energia, telecom, drenagem)",
            "Fotografias t√©cnicas e relat√≥rio descritivo do entorno imediato",
            "Verifica√ß√£o de condicionantes ambientais e legais (APPs, tombamentos, zoneamento, etc.)"
          ],
          "horasEstimadas": 7,
          "observacoes": "Base t√©cnica fundamental para todas as disciplinas do projeto"
        },
        
        // FASE 2: PROGRAMA DE NECESSIDADES
        "PN_PROGRAMA_NECESSIDADES": {
          "ordem": 2,
          "etapa": "A - CONCEP√á√ÉO",
          "nome": "PN - Programa de Necessidades",
          "prazo": 1,
          "valor": 1275,
          "percentual": 0.05,
          "disciplinas": ["ARQUITETURA"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Programa arquitet√¥nico/Briefing detalhado com tabela de ambientes, √°reas m√≠nimas e inter-rela√ß√µes",
            "Organograma funcional por setor de uso",
            "Fluxograma das atividades e usu√°rios (diagrama de uso e circula√ß√£o)",
            "Pr√©-dimensionamento dos ambientes com base em normas e boas pr√°ticas",
            "Defini√ß√£o de padr√£o de acabamento desejado (n√≠vel de qualidade por ambiente)",
            "Levantamento de premissas e restri√ß√µes t√©cnicas, legais, operacionais e econ√¥micas",
            "Relat√≥rio com diagn√≥stico das demandas, objetivos e prioridades do cliente"
          ],
          "horasEstimadas": 7,
          "observacoes": "Define requisitos funcionais e t√©cnicos para todas as disciplinas"
        },
        
        // FASE 3: ESTUDO DE VIABILIDADE
        "EV_ESTUDO_VIABILIDADE": {
          "ordem": 3,
          "etapa": "B - DEFINI√á√ÉO",
          "nome": "EV - Estudo de Viabilidade",
          "prazo": 2,
          "valor": 2550,
          "percentual": 0.1,
          "disciplinas": ["ARQUITETURA", "ESTRUTURAL"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Estudo de massa arquitet√¥nico (volumetria, implanta√ß√£o, ocupa√ß√£o do solo)",
            "An√°lise de viabilidade legal e urban√≠stica conforme o plano diretor e legisla√ß√£o local",
            "Pr√©-dimensionamento estrutural e avalia√ß√£o da solu√ß√£o t√©cnica adotada",
            "An√°lise de custos preliminar com base em √≠ndices e benchmarking",
            "Relat√≥rio de viabilidade t√©cnica, econ√¥mica e operacional",
            "Avalia√ß√£o de impacto ambiental preliminar (quando aplic√°vel)",
            "Matriz de riscos iniciais e proposi√ß√£o de solu√ß√µes ou mitiga√ß√£o"
          ],
          "horasEstimadas": 14,
          "observacoes": "Valida√ß√£o t√©cnica, legal e econ√¥mica da viabilidade do empreendimento"
        },
        
        // FASE 4: ESTUDO PRELIMINAR
        "EP_ESTUDO_PRELIMINAR": {
          "ordem": 4,
          "etapa": "B - DEFINI√á√ÉO",
          "nome": "EP - Estudo Preliminar",
          "prazo": 3,
          "valor": 3825,
          "percentual": 0.15,
          "disciplinas": ["ARQUITETURA"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Plantas baixas dos pavimentos com layout funcional",
            "Planta de cobertura com elementos t√©cnicos (caimentos, equipamentos, etc.)",
            "Cortes longitudinais e transversais principais",
            "Fachadas principais com volumetria e linguagem arquitet√¥nica",
            "Planta de situa√ß√£o e loca√ß√£o com afastamentos, acessos e orienta√ß√£o solar",
            "Memorial justificativo conceitual e t√©cnico (implanta√ß√£o, partido, fluxos, materiais)",
            "Estudo volum√©trico tridimensional (maquete eletr√¥nica ou f√≠sica simplificada)"
          ],
          "horasEstimadas": 21,
          "observacoes": "Defini√ß√£o da concep√ß√£o arquitet√¥nica e partido geral do projeto"
        },
        
        // FASE 5: ANTEPROJETO MULTIDISCIPLINAR
        "AP_ANTEPROJETO": {
          "ordem": 5,
          "etapa": "C - INTERFACES",
          "nome": "AP - Anteprojeto Multidisciplinar",
          "prazo": 6,
          "valor": 7650,
          "percentual": 0.3,
          "disciplinas": ["ARQUITETURA", "ESTRUTURAL", "INSTALACOES_ELETRICAS", "INSTALACOES_HIDRAULICAS"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Plantas baixas com dimensionamento e layouts definitivos",
            "Cortes e fachadas cotados",
            "Planta de cobertura detalhada com elementos t√©cnicos e construtivos",
            "Lan√ßamento da estrutura (planta de pilares, vigas, lajes e funda√ß√µes)",
            "Esquema vertical da distribui√ß√£o el√©trica e pontos principais",
            "Esquema vertical da rede hidr√°ulica e pontos principais",
            "Compatibiliza√ß√£o entre disciplinas (detec√ß√£o de interfer√™ncias)",
            "Memorial descritivo multidisciplinar consolidado",
            "Representa√ß√µes 3D ou maquetes eletr√¥nicas para comunica√ß√£o com o cliente"
          ],
          "horasEstimadas": 42,
          "observacoes": "Compatibiliza√ß√£o multidisciplinar e defini√ß√£o de todas as interfaces t√©cnicas"
        },
        
        // FASE 6: PROJETO LEGAL
        "PL_PROJETO_LEGAL": {
          "ordem": 6,
          "etapa": "D - APROVA√á√ÉO",
          "nome": "PL - Projeto Legal",
          "prazo": 3,
          "valor": 3825,
          "percentual": 0.15,
          "disciplinas": ["ARQUITETURA"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Plantas, cortes e fachadas conforme exig√™ncias do √≥rg√£o licenciador",
            "Memorial descritivo conforme legisla√ß√£o urban√≠stica e edil√≠cia",
            "Quadro de √°reas conforme ABNT NBR 13531 e normas locais/plano diretor",
            "Relat√≥rio t√©cnico de acessibilidade (se aplic√°vel)",
            "Documenta√ß√£o complementar exigida pela prefeitura (ART/RRT, formul√°rios, certid√µes, etc.)",
            "Indica√ß√£o de par√¢metros urban√≠sticos atendidos (gabarito, taxa de ocupa√ß√£o, etc.)"
          ],
          "horasEstimadas": 21,
          "observacoes": "Adequa√ß√£o √†s normas t√©cnicas e legisla√ß√£o para aprova√ß√£o legal"
        },
        
        // FASE 7: PROJETO B√ÅSICO MULTIDISCIPLINAR
        "PB_PROJETO_BASICO": {
          "ordem": 7,
          "etapa": "E - PROJETO B√ÅSICO",
          "nome": "PB - Projeto B√°sico Multidisciplinar",
          "prazo": 4,
          "valor": 5100,
          "percentual": 0.2,
          "disciplinas": ["ARQUITETURA", "ESTRUTURAL", "INSTALACOES_ELETRICAS", "INSTALACOES_HIDRAULICAS"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Projeto arquitet√¥nico b√°sico completo (plantas, cortes, fachadas e cobertura)",
            "Defini√ß√£o preliminar de materiais e acabamentos",
            "Indica√ß√£o de acessos, fluxos, usos e zoneamentos dos ambientes",
            "Lan√ßamento estrutural com dimensionamento preliminar dos elementos (vigas, pilares, lajes, funda√ß√µes)",
            "Indica√ß√£o dos principais sistemas estruturais adotados",
            "Memorial descritivo b√°sico da estrutura",
            "Planta baixa com pontos de energia, ilumina√ß√£o e quadros de distribui√ß√£o",
            "Diagrama unifilar simplificado",
            "Indica√ß√£o de carga estimada por ambiente e quadro geral",
            "Planta com tra√ßado preliminar de redes hidr√°ulicas e sanit√°rias",
            "Lan√ßamento dos principais pontos de consumo e esgoto",
            "Indica√ß√£o do sistema de abastecimento e esgotamento",
            "Descri√ß√£o t√©cnica preliminar dos sistemas e materiais por disciplina",
            "Diretrizes para projeto executivo",
            "Indica√ß√µes de desempenho m√≠nimo esperado (conforme NBR 15575)",
            "Estimativa de custos por disciplina (baseada em projetos b√°sicos)",
            "Cronograma f√≠sico-financeiro preliminar com macroetapas",
            "Diretrizes para planejamento executivo da obra"
          ],
          "horasEstimadas": 28,
          "observacoes": "Projeto b√°sico multidisciplinar completo - base t√©cnica para licita√ß√£o e contrata√ß√£o da obra",
          
          "detalhamentoPorDisciplina": {
            "ARQUITETURA": {
              "entregaveis": [
                "Projeto arquitet√¥nico b√°sico completo (plantas, cortes, fachadas e cobertura)",
                "Defini√ß√£o preliminar de materiais e acabamentos",
                "Indica√ß√£o de acessos, fluxos, usos e zoneamentos dos ambientes"
              ],
              "observacoes": "Base arquitet√¥nica para todas as outras disciplinas"
            },
            "ESTRUTURAL": {
              "entregaveis": [
                "Lan√ßamento estrutural com dimensionamento preliminar dos elementos (vigas, pilares, lajes, funda√ß√µes)",
                "Indica√ß√£o dos principais sistemas estruturais adotados",
                "Memorial descritivo b√°sico da estrutura"
              ],
              "observacoes": "Dimensionamento preliminar para estimativa de custos"
            },
            "INSTALACOES_ELETRICAS": {
              "entregaveis": [
                "Planta baixa com pontos de energia, ilumina√ß√£o e quadros de distribui√ß√£o",
                "Diagrama unifilar simplificado",
                "Indica√ß√£o de carga estimada por ambiente e quadro geral"
              ],
              "observacoes": "Base para dimensionamento da infraestrutura el√©trica"
            },
            "INSTALACOES_HIDRAULICAS": {
              "entregaveis": [
                "Planta com tra√ßado preliminar de redes hidr√°ulicas e sanit√°rias",
                "Lan√ßamento dos principais pontos de consumo e esgoto",
                "Indica√ß√£o do sistema de abastecimento e esgotamento"
              ],
              "observacoes": "Defini√ß√£o dos sistemas hidrossanit√°rios principais"
            }
          },
          
          "produtosFinais": [
            "Especifica√ß√µes t√©cnicas preliminares por disciplina",
            "Estimativa de custos detalhada por disciplina",
            "Cronograma f√≠sico-financeiro preliminar",
            "Diretrizes t√©cnicas para projeto executivo",
            "Memorial descritivo multidisciplinar b√°sico"
          ]
        },
        
        // FASE 8: PROJETO EXECUTIVO COMPLETO
        "PE_PROJETO_EXECUTIVO": {
          "ordem": 8,
          "etapa": "F - PROJETO EXECUTIVO",
          "nome": "PE - Projeto Executivo Completo",
          "prazo": 6,
          "valor": 7650,
          "percentual": 0.3,
          "disciplinas": ["ARQUITETURA", "ESTRUTURAL", "INSTALACOES_ELETRICAS", "INSTALACOES_HIDRAULICAS"],
          "responsavel": "Equipe T√©cnica",
          "entregaveis": [
            "Projeto arquitet√¥nico executivo com todos os detalhes construtivos (plantas, cortes, fachadas, pagina√ß√µes)",
            "Projeto estrutural completo com detalhamento de armaduras, funda√ß√µes, lajes e pe√ßas especiais",
            "Projeto el√©trico executivo (plantas, quadros, detalhes, diagramas, lista de materiais e cargas)",
            "Projeto hidrossanit√°rio executivo (plantas, cortes, detalhes, reservat√≥rios, bombeamento, etc.)",
            "Projetos complementares: preven√ß√£o contra inc√™ndio, l√≥gica, SPDA, climatiza√ß√£o (quando aplic√°vel)",
            "Detalhamentos construtivos em escala apropriada (1:20, 1:10, 1:5, etc.)",
            "Especifica√ß√µes t√©cnicas completas por disciplina",
            "Caderno de encargos com obriga√ß√µes contratuais e crit√©rios de medi√ß√£o",
            "Lista de materiais e componentes construtivos",
            "Memoriais de c√°lculo estrutural (funda√ß√µes, lajes, vigas, etc.)",
            "Memoriais descritivos por disciplina atualizados e consolidados",
            "Planejamento executivo com sequenciamento de execu√ß√£o, log√≠stica e recomenda√ß√µes"
          ],
          "horasEstimadas": 42,
          "observacoes": "Informa√ß√µes t√©cnicas completas e detalhadas para execu√ß√£o da obra"
        }
      }
    };
    
    console.log('üìã CRONOGRAMA ATUALIZADO COM DETALHAMENTO T√âCNICO:');
    console.log('-'.repeat(60));
    
    // Mostrar resumo das atualiza√ß√µes
    Object.entries(cronogramaAtualizado.fases).forEach(([key, fase]) => {
      console.log(`${fase.ordem}. ${fase.nome}`);
      console.log(`   üìã Etapa NBR: ${fase.etapa}`);
      console.log(`   üë• Respons√°vel: ${fase.responsavel}`);
      console.log(`   üì¶ Entreg√°veis: ${fase.entregaveis.length} itens t√©cnicos`);
      console.log(`   üí∞ Valor: R$ ${fase.valor.toLocaleString('pt-BR')}`);
      console.log('');
    });
    
    // Atualizar no banco
    const updateResult = await client.query(`
      UPDATE orcamentos 
      SET 
        cronograma = $1,
        updated_at = NOW()
      WHERE id = $2
    `, [JSON.stringify(cronogramaAtualizado), orcamentoId]);
    
    console.log('‚úÖ CRONOGRAMA ATUALIZADO NO BANCO');
    console.log(`üîÑ Linhas afetadas: ${updateResult.rowCount}`);
    
    console.log('\nüéØ MELHORIAS IMPLEMENTADAS:');
    console.log('‚úÖ Detalhamento t√©cnico profissional completo');
    console.log('‚úÖ Entreg√°veis espec√≠ficos conforme NBR 13532');
    console.log('‚úÖ Respons√°vel definido para cada fase');
    console.log('‚úÖ Observa√ß√µes t√©cnicas detalhadas');
    console.log('‚úÖ Conformidade com normas t√©cnicas brasileiras');
    console.log('‚úÖ Linguagem t√©cnica apropriada para AEC');
    
    console.log('\nüìä ESTAT√çSTICAS:');
    const totalEntregaveis = Object.values(cronogramaAtualizado.fases)
      .reduce((total, fase) => total + fase.entregaveis.length, 0);
    console.log(`üì¶ Total de entreg√°veis: ${totalEntregaveis}`);
    console.log(`üìÖ Total de fases: ${Object.keys(cronogramaAtualizado.fases).length}`);
    console.log(`‚è±Ô∏è Prazo total: ${cronogramaAtualizado.prazoTotal} semanas`);
    console.log(`üí∞ Valor t√©cnico: R$ ${cronogramaAtualizado.valorTecnicoTotal.toLocaleString('pt-BR')}`);
    
  } catch (error) {
    console.error('‚ùå Erro na atualiza√ß√£o:', error);
  } finally {
    await client.end();
  }
}

atualizarCronogramaDetalhado();